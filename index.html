<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Chat Bubble</title>
<link rel="icon" type="image/png" href="images/icon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400&family=Fraunces:ital,opsz,wght@0,9..144,200;0,9..144,300;1,9..144,200&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:           #0b0b0d;
  --surface:      #131316;
  --surface2:     #1a1a1f;
  --surface3:     #202026;
  --border:       #252529;
  --border-strong:#333339;
  --text:         #e4e2dc;
  --text-muted:   #565660;
  --text-dim:     #353540;
  --accent:       #4ade80;
  --accent-dim:   #162a1e;
  --danger:       #f87171;
  --mono:         'DM Mono', monospace;
  --serif:        'Fraunces', serif;
  --sidebar-w:    280px;
}

html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--mono); font-size: 13px; line-height: 1.6; overflow: hidden; }

.page { position: fixed; inset: 0; display: none; flex-direction: column; }
.page.active { display: flex; }

#auth-page { align-items: center; justify-content: center; background: var(--bg); }

.auth-glow {
  position: absolute; width: 600px; height: 600px; border-radius: 50%;
  background: radial-gradient(circle, rgba(74,222,128,0.05) 0%, transparent 70%);
  pointer-events: none; top: 50%; left: 50%; transform: translate(-50%, -50%);
}

.auth-card {
  width: 390px; max-width: calc(100vw - 32px); background: var(--surface);
  border: 1px solid var(--border); border-radius: 18px; padding: 32px;
  box-shadow: 0 32px 80px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.03) inset;
  position: relative; z-index: 1; animation: cardIn 0.4s cubic-bezier(0.2,0,0,1);
  max-height: calc(100vh - 32px); overflow-y: auto;
}

@keyframes cardIn {
  from { opacity: 0; transform: translateY(16px) scale(0.97); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

.auth-brand { display: flex; align-items: center; gap: 10px; margin-bottom: 28px; }
.auth-logo { width: 32px; height: 32px; background: var(--accent-dim); border: 1px solid rgba(74,222,128,0.2); border-radius: 9px; display: grid; place-items: center; }
.auth-logo svg { width: 15px; height: 15px; stroke: var(--accent); fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }
.auth-brand-name { font-family: var(--serif); font-weight: 200; font-size: 17px; letter-spacing: -0.3px; }
.auth-title { font-family: var(--serif); font-weight: 200; font-size: 24px; letter-spacing: -0.5px; margin-bottom: 4px; }
.auth-sub { font-size: 11px; color: var(--text-muted); margin-bottom: 24px; }

.github-auth-btn {
  width: 100%; padding: 11px; border-radius: 9px; border: 1px solid var(--border-strong);
  background: var(--surface2); color: var(--text); font-family: var(--mono); font-size: 13px;
  cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center;
  gap: 9px; margin-bottom: 20px;
}
.github-auth-btn:hover { background: var(--surface3); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
.github-auth-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.github-auth-btn svg { width: 16px; height: 16px; fill: var(--text); flex-shrink: 0; }

.auth-divider { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
.auth-divider-line { flex: 1; height: 1px; background: var(--border); }
.auth-divider-text { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.8px; white-space: nowrap; }

.form-field { margin-bottom: 14px; }
.form-label { display: block; font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 6px; }
.form-input { width: 100%; padding: 10px 14px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: var(--mono); font-size: 13px; outline: none; transition: border-color 0.15s, background 0.15s; -webkit-user-select: text; user-select: text; }
.form-input:focus { border-color: var(--accent); background: var(--surface3); }
.form-input::placeholder { color: var(--text-dim); }

.password-rules { font-size: 10px; color: var(--text-dim); margin-top: 6px; display: flex; flex-wrap: wrap; gap: 6px; }
.pw-rule { padding: 2px 7px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); transition: all 0.2s; }
.pw-rule.met { color: var(--accent); border-color: rgba(74,222,128,0.3); background: var(--accent-dim); }

.auth-btn { width: 100%; padding: 11px; border-radius: 9px; border: none; background: var(--accent); color: #061208; font-family: var(--mono); font-size: 13px; cursor: pointer; transition: all 0.15s; margin-top: 4px; }
.auth-btn:hover { filter: brightness(1.08); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(74,222,128,0.2); }
.auth-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: none; box-shadow: none; }

.auth-switch { text-align: center; margin-top: 18px; font-size: 12px; color: var(--text-muted); }
.auth-switch a { color: var(--accent); text-decoration: none; cursor: pointer; }
.auth-switch a:hover { text-decoration: underline; }

.auth-global-error { background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.2); border-radius: 8px; padding: 10px 14px; font-size: 12px; color: var(--danger); margin-bottom: 16px; display: none; line-height: 1.5; }
.auth-global-error.visible { display: block; }

#username-setup { display: none; }

#app-page { display: none; flex-direction: row; height: 100%; overflow: hidden; }
#app-page.active { display: flex; }

.sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 199; backdrop-filter: blur(2px); }

.sidebar {
  width: var(--sidebar-w); flex-shrink: 0; background: var(--surface);
  border-right: 1px solid var(--border); display: flex; flex-direction: column;
  height: 100%; z-index: 200; transition: transform 0.28s cubic-bezier(0.2,0,0,1);
}

.sidebar-header { padding: 16px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
.sidebar-logo { width: 26px; height: 26px; background: var(--accent-dim); border: 1px solid rgba(74,222,128,0.15); border-radius: 7px; display: grid; place-items: center; flex-shrink: 0; }
.sidebar-logo svg { width: 13px; height: 13px; stroke: var(--accent); fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }
.sidebar-title { font-family: var(--serif); font-weight: 200; font-size: 15px; letter-spacing: -0.3px; flex: 1; }

.sidebar-close-btn { display: none; width: 26px; height: 26px; border-radius: 7px; border: 1px solid var(--border); background: var(--surface2); color: var(--text-muted); cursor: pointer; place-items: center; transition: all 0.15s; flex-shrink: 0; }
.sidebar-close-btn svg { width: 12px; height: 12px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; }

.sidebar-user-btn { width: 26px; height: 26px; border-radius: 7px; border: 1px solid var(--border); background: var(--surface2); display: grid; place-items: center; cursor: pointer; transition: all 0.15s; position: relative; }
.sidebar-user-btn:hover { background: var(--surface3); border-color: var(--border-strong); }
.sidebar-user-btn svg { width: 12px; height: 12px; stroke: var(--text-muted); fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }

.user-dropdown { position: absolute; top: calc(100% + 6px); right: 0; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 6px; min-width: 170px; box-shadow: 0 12px 36px rgba(0,0,0,0.5); z-index: 500; display: none; }
.user-dropdown.open { display: block; }
.user-dd-name { font-size: 11px; color: var(--text-muted); padding: 6px 10px 8px; border-bottom: 1px solid var(--border); margin-bottom: 4px; }
.user-dd-name strong { display: block; color: var(--text); font-weight: 400; font-size: 12px; margin-top: 1px; }
.user-dd-item { display: flex; align-items: center; gap: 8px; padding: 7px 10px; border-radius: 6px; font-size: 12px; color: var(--text-muted); cursor: pointer; transition: all 0.1s; border: none; background: none; width: 100%; font-family: var(--mono); text-align: left; }
.user-dd-item:hover { color: var(--text); background: var(--surface3); }
.user-dd-item.danger:hover { color: var(--danger); background: rgba(248,113,113,0.08); }
.user-dd-item svg { width: 12px; height: 12px; stroke: currentColor; fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }

.sidebar-section { padding: 12px 12px 6px; font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.8px; display: flex; align-items: center; justify-content: space-between; }

.chat-list { flex: 1; overflow-y: auto; padding: 4px 8px; }
.chat-list::-webkit-scrollbar { width: 3px; }
.chat-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.chat-item { display: flex; align-items: center; gap: 10px; padding: 9px 10px; border-radius: 8px; cursor: pointer; transition: all 0.12s; margin-bottom: 2px; position: relative; }
.chat-item:hover { background: var(--surface2); }
.chat-item.active { background: var(--surface3); }

.chat-avatar { width: 32px; height: 32px; border-radius: 8px; background: var(--surface3); border: 1px solid var(--border); display: grid; place-items: center; font-size: 13px; flex-shrink: 0; color: var(--text-muted); font-family: var(--serif); font-weight: 200; text-transform: uppercase; position: relative; }
.chat-item-info { flex: 1; min-width: 0; }
.chat-item-name { font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 1px; }
.chat-item-preview { font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.chat-item-del { width: 22px; height: 22px; border-radius: 5px; border: none; background: none; color: var(--text-dim); cursor: pointer; display: grid; place-items: center; opacity: 0; transition: all 0.12s; flex-shrink: 0; }
.chat-item:hover .chat-item-del { opacity: 1; }
.chat-item-del:hover { color: var(--danger); background: rgba(248,113,113,0.1); }
.chat-item-del svg { width: 11px; height: 11px; stroke: currentColor; fill: none; stroke-width: 1.5; }

.unread-badge { position: absolute; top: -4px; right: -4px; width: 14px; height: 14px; border-radius: 50%; background: var(--accent); border: 2px solid var(--surface); display: none; }
.unread-badge.visible { display: block; }

.chat-empty { padding: 32px 16px; text-align: center; color: var(--text-dim); font-size: 12px; line-height: 1.9; }
.chat-empty-icon { font-size: 26px; margin-bottom: 8px; opacity: 0.4; }

.sidebar-footer { border-top: 1px solid var(--border); padding: 12px; }
.code-display-mini { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
.code-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 2px; }
.code-value { font-size: 15px; letter-spacing: 4px; color: var(--accent); font-weight: 300; }
.code-copy-btn { width: 24px; height: 24px; border-radius: 5px; border: 1px solid var(--border); background: none; color: var(--text-muted); cursor: pointer; display: grid; place-items: center; transition: all 0.12s; flex-shrink: 0; }
.code-copy-btn:hover { color: var(--accent); border-color: rgba(74,222,128,0.3); }
.code-copy-btn svg { width: 11px; height: 11px; stroke: currentColor; fill: none; stroke-width: 1.5; stroke-linecap: round; }
.join-btn { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: none; font-family: var(--mono); font-size: 11px; color: var(--text-muted); cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 6px; }
.join-btn:hover { color: var(--text); border-color: var(--border-strong); background: var(--surface2); }
.join-btn svg { width: 12px; height: 12px; stroke: currentColor; fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }

.chat-area { flex: 1; display: flex; flex-direction: column; min-width: 0; background: var(--bg); }

.chat-welcome { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; color: var(--text-dim); }
.chat-welcome-icon { width: 52px; height: 52px; border-radius: 13px; background: var(--surface); border: 1px solid var(--border); display: grid; place-items: center; margin-bottom: 4px; }
.chat-welcome-icon svg { width: 22px; height: 22px; stroke: var(--text-dim); fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }
.chat-welcome h2 { font-family: var(--serif); font-weight: 200; font-size: 19px; color: var(--text-muted); letter-spacing: -0.3px; }
.chat-welcome p { font-size: 12px; text-align: center; max-width: 240px; line-height: 1.7; }

.chat-header { padding: 13px 16px; border-bottom: 1px solid var(--border); background: var(--surface); display: none; align-items: center; gap: 12px; flex-shrink: 0; }
.chat-header.visible { display: flex; }

.hamburger-btn { display: none; width: 34px; height: 34px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface2); color: var(--text-muted); cursor: pointer; place-items: center; flex-shrink: 0; transition: all 0.15s; }
.hamburger-btn svg { width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; }

.chat-header-avatar { width: 34px; height: 34px; border-radius: 8px; background: var(--surface2); border: 1px solid var(--border); display: grid; place-items: center; font-family: var(--serif); font-size: 14px; font-weight: 200; color: var(--text-muted); text-transform: uppercase; flex-shrink: 0; }
.chat-header-info { flex: 1; }
.chat-header-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 1px; }
.chat-header-name { font-size: 14px; color: var(--text); font-family: var(--serif); font-weight: 200; letter-spacing: -0.2px; }

.mobile-topbar { display: none; padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--surface); align-items: center; gap: 10px; flex-shrink: 0; }
.mobile-topbar-logo { font-family: var(--serif); font-weight: 200; font-size: 15px; letter-spacing: -0.3px; flex: 1; }

.messages-wrap { flex: 1; overflow-y: auto; padding: 20px; display: none; flex-direction: column; gap: 3px; }
.messages-wrap.visible { display: flex; }
.messages-wrap::-webkit-scrollbar { width: 3px; }
.messages-wrap::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.msg-row { display: flex; align-items: flex-end; gap: 8px; }
.msg-row.mine { flex-direction: row-reverse; }
.msg-avatar { width: 24px; height: 24px; border-radius: 6px; background: var(--surface2); border: 1px solid var(--border); display: grid; place-items: center; font-size: 10px; color: var(--text-muted); font-family: var(--serif); text-transform: uppercase; flex-shrink: 0; }
.msg-avatar.hidden { visibility: hidden; }
.msg-bubble { max-width: 68%; padding: 9px 13px; border-radius: 12px; font-size: 13px; line-height: 1.55; word-break: break-word; -webkit-user-select: text; user-select: text; }
.msg-row:not(.mine) .msg-bubble { background: var(--surface); border: 1px solid var(--border); border-bottom-left-radius: 3px; color: var(--text); }
.msg-row.mine .msg-bubble { background: var(--accent-dim); border: 1px solid rgba(74,222,128,0.2); border-bottom-right-radius: 3px; color: #c8f5da; }
.msg-time { font-size: 9px; color: var(--text-dim); padding: 0 4px; white-space: nowrap; align-self: flex-end; margin-bottom: 4px; }
.msg-date-divider { text-align: center; font-size: 10px; color: var(--text-dim); padding: 10px 0 6px; letter-spacing: 0.4px; }

.chat-input-bar { padding: 13px 16px; border-top: 1px solid var(--border); background: var(--surface); display: none; gap: 10px; align-items: flex-end; }
.chat-input-bar.visible { display: flex; }
.chat-input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; color: var(--text); font-family: var(--mono); font-size: 13px; outline: none; resize: none; max-height: 120px; min-height: 40px; line-height: 1.5; transition: border-color 0.15s; -webkit-user-select: text; user-select: text; }
.chat-input:focus { border-color: var(--border-strong); }
.chat-input::placeholder { color: var(--text-dim); }

.send-btn { width: 40px; height: 40px; border-radius: 10px; border: none; background: var(--accent); color: #061208; cursor: pointer; display: grid; place-items: center; flex-shrink: 0; transition: all 0.15s; }
.send-btn:hover { filter: brightness(1.1); transform: scale(1.05); }
.send-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; filter: none; }
.send-btn svg { width: 15px; height: 15px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

.modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); padding: 16px; }
.modal-backdrop.visible { display: flex; animation: bkIn 0.18s ease; }
@keyframes bkIn { from{opacity:0} to{opacity:1} }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; width: 400px; max-width: 100%; box-shadow: 0 28px 80px rgba(0,0,0,0.8); animation: mIn 0.2s cubic-bezier(0.2,0,0,1); overflow: hidden; }
@keyframes mIn { from{opacity:0;transform:scale(0.94) translateY(8px)} to{opacity:1;transform:scale(1) translateY(0)} }
.modal-header { padding: 20px 20px 0; display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.modal-title { font-family: var(--serif); font-weight: 200; font-size: 18px; letter-spacing: -0.3px; }
.modal-close { width: 28px; height: 28px; border-radius: 7px; border: 1px solid var(--border); background: none; color: var(--text-muted); cursor: pointer; display: grid; place-items: center; font-size: 16px; transition: all 0.12s; }
.modal-close:hover { color: var(--text); background: var(--surface2); }
.modal-body { padding: 0 20px 20px; }
.modal-btn-row { display: flex; gap: 8px; margin-top: 16px; }
.modal-btn { flex: 1; padding: 9px; border-radius: 8px; border: 1px solid var(--border); background: none; font-family: var(--mono); font-size: 12px; color: var(--text-muted); cursor: pointer; transition: all 0.15s; }
.modal-btn:hover { color: var(--text); background: var(--surface2); }
.modal-btn.accent { background: var(--accent); border-color: var(--accent); color: #061208; }
.modal-btn.accent:hover { filter: brightness(1.08); }
.modal-btn.accent:disabled { opacity: 0.4; cursor: not-allowed; filter: none; }
.modal-btn.danger { background: rgba(248,113,113,0.08); border-color: rgba(248,113,113,0.25); color: var(--danger); }
.modal-btn.danger:hover { background: rgba(248,113,113,0.15); }
.modal-error { font-size: 11px; color: var(--danger); margin-top: 8px; min-height: 16px; }

.join-input { width: 100%; padding: 12px 14px; background: var(--surface2); border: 1px solid var(--border); border-radius: 9px; color: var(--text); font-family: var(--mono); font-size: 20px; letter-spacing: 6px; text-transform: uppercase; text-align: center; outline: none; transition: border-color 0.15s; -webkit-user-select: text; user-select: text; }
.join-input:focus { border-color: var(--accent); }
.join-input.error { border-color: var(--danger); animation: shake 0.35s ease; }
.join-input::placeholder { letter-spacing: 2px; font-size: 13px; color: var(--text-dim); text-transform: none; }
@keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-5px)} 40%{transform:translateX(5px)} 60%{transform:translateX(-3px)} 80%{transform:translateX(3px)} }

.toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(60px); background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 10px 18px; font-size: 12px; color: var(--text); z-index: 9999; transition: transform 0.28s cubic-bezier(0.2,0,0,1), opacity 0.28s; opacity: 0; white-space: nowrap; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.toast.success { border-color: rgba(74,222,128,0.3); color: var(--accent); }
.toast.error { border-color: rgba(248,113,113,0.3); color: var(--danger); }

* { scrollbar-width: thin; scrollbar-color: var(--border) transparent; }

.typing-indicator { padding: 0 16px 8px; font-size: 11px; color: var(--text-dim); min-height: 24px; display: flex; align-items: center; gap: 6px; }
.typing-indicator.visible { color: var(--text-muted); }
.typing-dots { display: flex; gap: 3px; align-items: center; }
.typing-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--text-muted); animation: typingBounce 1.1s ease-in-out infinite; }
.typing-dot:nth-child(2) { animation-delay: 0.18s; }
.typing-dot:nth-child(3) { animation-delay: 0.36s; }
@keyframes typingBounce { 0%,60%,100%{transform:translateY(0);opacity:0.4} 30%{transform:translateY(-4px);opacity:1} }

#ctx-menu { position: fixed; z-index: 9999; background: var(--surface2); border: 1px solid var(--border-strong); border-radius: 10px; padding: 5px; min-width: 170px; box-shadow: 0 12px 40px rgba(0,0,0,0.6); display: none; animation: ctxIn 0.12s cubic-bezier(0.2,0,0,1); }
@keyframes ctxIn { from{opacity:0;transform:scale(0.95)} to{opacity:1;transform:scale(1)} }
#ctx-menu.visible { display: block; }
.ctx-item { display: flex; align-items: center; gap: 9px; width: 100%; padding: 8px 11px; border-radius: 6px; border: none; background: none; font-family: var(--mono); font-size: 12px; color: var(--text-muted); cursor: pointer; transition: all 0.1s; text-align: left; }
.ctx-item:hover { color: var(--text); background: var(--surface3); }
.ctx-item.danger { color: var(--danger); }
.ctx-item.danger:hover { background: rgba(248,113,113,0.1); }
.ctx-item svg { width: 13px; height: 13px; stroke: currentColor; fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; flex-shrink: 0; }
.ctx-sep { height: 1px; background: var(--border); margin: 4px 0; }

@media (max-width: 640px) {
  .sidebar { position: fixed; top: 0; left: 0; bottom: 0; transform: translateX(-100%); box-shadow: 4px 0 32px rgba(0,0,0,0.6); }
  .sidebar.open { transform: translateX(0); }
  .sidebar-overlay.open { display: block; }
  .sidebar-close-btn { display: grid; }
  .hamburger-btn { display: grid; }
  .mobile-topbar { display: flex; }
  .chat-header.visible { display: flex; }
  .chat-area { position: relative; }
  .msg-bubble { max-width: 82%; }
  .messages-wrap { padding: 12px; }
  .chat-input-bar { padding: 10px 12px; }
  .auth-card { padding: 24px 20px; }
}
</style>
</head>
<body>

<div id="auth-page" class="page active">
  <div class="auth-glow"></div>
  <div class="auth-card">
    <div class="auth-brand">
      <div class="auth-logo">
        <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      </div>
      <span class="auth-brand-name">Chat Bubble</span>
    </div>

    <div class="auth-global-error" id="auth-global-error"></div>

    <div id="login-form">
      <div class="auth-title">Welcome back.</div>
      <div class="auth-sub">Sign in to continue chatting</div>
      <button class="github-auth-btn" id="github-login-btn" onclick="doGithubAuth()">
        <svg viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
        Continue with GitHub
      </button>
      <div class="auth-divider">
        <div class="auth-divider-line"></div>
        <div class="auth-divider-text">or sign in with email</div>
        <div class="auth-divider-line"></div>
      </div>
      <div class="form-field">
        <label class="form-label">Email</label>
        <input class="form-input" id="login-email" type="email" placeholder="you@email.com" autocomplete="email">
      </div>
      <div class="form-field">
        <label class="form-label">Password</label>
        <input class="form-input" id="login-password" type="password" placeholder="••••••••" autocomplete="current-password">
      </div>
      <button class="auth-btn" id="login-btn" onclick="doLogin()">Sign In</button>
      <div class="auth-switch">Don't have an account? <a onclick="showSignup()">Sign up</a></div>
    </div>

    <div id="signup-form" style="display:none">
      <div class="auth-title">Create account.</div>
      <div class="auth-sub">Join Chat Bubble</div>
      <button class="github-auth-btn" id="github-signup-btn" onclick="doGithubAuth()">
        <svg viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
        Sign up with GitHub
      </button>
      <div class="auth-divider">
        <div class="auth-divider-line"></div>
        <div class="auth-divider-text">or sign up with email</div>
        <div class="auth-divider-line"></div>
      </div>
      <div class="form-field">
        <label class="form-label">Email</label>
        <input class="form-input" id="signup-email" type="email" placeholder="you@email.com" autocomplete="email">
      </div>
      <div class="form-field">
        <label class="form-label">Password</label>
        <input class="form-input" id="signup-password" type="password" placeholder="••••••••" autocomplete="new-password" oninput="checkPasswordRules(this.value)">
        <div class="password-rules">
          <span class="pw-rule" id="rule-upper">A uppercase</span>
          <span class="pw-rule" id="rule-lower">a lowercase</span>
          <span class="pw-rule" id="rule-num">0 number</span>
          <span class="pw-rule" id="rule-special">* special</span>
        </div>
      </div>
      <button class="auth-btn" id="signup-btn" onclick="doSignup()">Create Account</button>
      <div class="auth-switch">Already have an account? <a onclick="showLogin()">Sign in</a></div>
    </div>

    <div id="username-setup">
      <div class="auth-title">One more thing.</div>
      <div class="auth-sub">Before you start chatting, set up your profile</div>
      <div class="form-field">
        <label class="form-label">Username</label>
        <input class="form-input" id="setup-username" type="text" placeholder="cooluser" autocomplete="off" maxlength="20" oninput="clearOnboardingError()">
        <div style="font-size:10px;color:var(--text-dim);margin-top:5px">2–20 characters. Letters, numbers, underscores.</div>
      </div>
      <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:16px">
        <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;-webkit-user-select:none;user-select:none">
          <input type="checkbox" id="tos-checkbox" style="margin-top:2px;accent-color:var(--accent);width:13px;height:13px;flex-shrink:0;cursor:pointer">
          <span style="font-size:12px;color:var(--text-muted);line-height:1.6">I agree to follow all TOS and common sense.</span>
        </label>
      </div>
      <div class="auth-global-error" id="onboarding-error" style="display:none"></div>
      <button class="auth-btn" id="setup-btn" onclick="doUsernameSetup()">Enter Chat Bubble</button>
    </div>
  </div>
</div>

<div id="app-page" class="page">
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      </div>
      <span class="sidebar-title">Chat Bubble</span>
      <div style="position:relative">
        <button class="sidebar-user-btn" id="user-btn" onclick="toggleUserDropdown()">
          <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </button>
        <div class="user-dropdown" id="user-dropdown">
          <div class="user-dd-name">Signed in as<strong id="dd-username">—</strong></div>
          <button class="user-dd-item danger" onclick="doLogout()">
            <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Sign Out
          </button>
        </div>
      </div>
      <button class="sidebar-close-btn" onclick="closeSidebar()">
        <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>

    <div class="sidebar-section">
      Chats
      <span style="font-size:10px;color:var(--text-dim);letter-spacing:0;text-transform:none">share your code →</span>
    </div>

    <div class="chat-list" id="chat-list">
      <div class="chat-empty"><div class="chat-empty-icon"><i class="fa-regular fa-comments"></i></div>No chats yet.<br>Use someone's code below.</div>
    </div>

    <div class="sidebar-footer">
      <div class="code-display-mini">
        <div>
          <div class="code-label">Your Chat Code</div>
          <div class="code-value" id="my-chat-code">——————</div>
        </div>
        <button class="code-copy-btn" onclick="copyMyChatCode()" title="Copy code">
          <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        </button>
      </div>
      <button class="join-btn" onclick="openJoinChat()">
        <svg viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="9" y2="12"/></svg>
        Use someone's code
      </button>
      <button class="join-btn" style="margin-top:6px" id="notif-toggle-btn" onclick="toggleNotifications()">
        <i class="fa-regular fa-bell" style="width:12px;font-size:12px"></i>
        Enable Notifications
      </button>
    </div>
  </div>

  <div class="chat-area">
    <div class="mobile-topbar" id="mobile-topbar">
      <button class="hamburger-btn" onclick="openSidebar()" style="display:grid">
        <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <span class="mobile-topbar-logo">Chat Bubble</span>
      <div style="position:relative">
        <button class="sidebar-user-btn" onclick="toggleUserDropdownMobile()">
          <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </button>
        <div class="user-dropdown" id="user-dropdown-mobile">
          <div class="user-dd-name">Signed in as<strong id="dd-username-mobile">—</strong></div>
          <button class="user-dd-item danger" onclick="doLogout()">
            <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Sign Out
          </button>
        </div>
      </div>
    </div>

    <div class="chat-welcome" id="chat-welcome">
      <div class="chat-welcome-icon">
        <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      </div>
      <h2>Start chatting</h2>
      <p>Select a chat, or enter someone's chat code to start a new conversation.</p>
    </div>

    <div class="chat-header" id="chat-header">
      <button class="hamburger-btn" onclick="openSidebar()">
        <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="chat-header-avatar" id="chat-header-avatar">?</div>
      <div class="chat-header-info">
        <div class="chat-header-label">You are chatting with</div>
        <div class="chat-header-name" id="chat-header-name">—</div>
      </div>
    </div>

    <div class="messages-wrap" id="messages-wrap"></div>
    <div class="typing-indicator" id="typing-indicator"></div>

    <div class="chat-input-bar" id="chat-input-bar">
      <textarea class="chat-input" id="chat-input" placeholder="Type a message…" rows="1"
        onkeydown="handleInputKey(event)" oninput="autoResize(this); handleTyping()"></textarea>
      <button class="send-btn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- JOIN MODAL -->
<div class="modal-backdrop" id="join-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Join a Chat</div>
      <button class="modal-close" onclick="closeJoinModal()">×</button>
    </div>
    <div class="modal-body">
      <input class="join-input" id="join-input" maxlength="6" placeholder="Enter code"
        autocomplete="off" spellcheck="false"
        oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')"
        onkeydown="if(event.key==='Enter') doJoinChat()">
      <div class="modal-error" id="join-error"></div>
      <div class="modal-btn-row">
        <button class="modal-btn" onclick="closeJoinModal()">Cancel</button>
        <button class="modal-btn accent" id="join-submit-btn" onclick="doJoinChat()">Join</button>
      </div>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="modal-backdrop" id="delete-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Delete Chat</div>
      <button class="modal-close" onclick="closeDeleteModal()">×</button>
    </div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text-muted);line-height:1.7">Are you sure? All messages will be permanently removed. This cannot be undone.</p>
      <div class="modal-btn-row">
        <button class="modal-btn" onclick="closeDeleteModal()">Cancel</button>
        <button class="modal-btn danger" id="confirm-delete-btn" onclick="confirmDeleteChat()">Delete Chat</button>
      </div>
    </div>
  </div>
</div>

<!-- REPORT MODAL -->
<div class="modal-backdrop" id="report-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Report User</div>
      <button class="modal-close" onclick="closeReportModal()">×</button>
    </div>
    <div class="modal-body">
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:14px;line-height:1.6">
        Reporting: <strong id="report-target-name" style="color:var(--text)">—</strong>
      </div>
      <div class="form-field">
        <label class="form-label">Reason</label>
        <textarea id="report-reason" class="form-input" placeholder="Describe what happened…" rows="4"
          style="resize:none;height:auto;min-height:90px;-webkit-user-select:text;user-select:text"></textarea>
      </div>
      <div class="modal-error" id="report-error"></div>
      <div class="modal-btn-row">
        <button class="modal-btn" onclick="closeReportModal()">Cancel</button>
        <button class="modal-btn danger" id="report-submit-btn" onclick="submitReport()" style="background:rgba(248,113,113,0.12);border-color:rgba(248,113,113,0.3);color:var(--danger)">Submit Report</button>
      </div>
    </div>
  </div>
</div>

<!-- CONTEXT MENU -->
<div id="ctx-menu">
  <button class="ctx-item" id="ctx-report-btn" onclick="ctxReport()">
    <svg viewBox="0 0 24 24"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>
    Report User
  </button>
  <button class="ctx-item" onclick="ctxRefresh()">
    <svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
    Refresh Page
  </button>
  <div class="ctx-sep" id="ctx-sep"></div>
  <button class="ctx-item danger" id="ctx-logout-btn" onclick="ctxLogout()">
    <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
    Log Out
  </button>
</div>

<div class="toast" id="toast"></div>

<script>
/* ══════════════════════════════════════════════════════
   CONFIG
══════════════════════════════════════════════════════ */
const SUPABASE_URL  = 'https://wkgjqpcjoctfoovdtbxf.supabase.co';
const SUPABASE_ANON = 'sb_publishable_GEMM0Aw5hDIH7QNV_Uq_hQ_iSE5LeO7';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
  realtime: { params: { eventsPerSecond: 20 } }
});

/* ── STATE ── */
let currentUser      = null;
let currentProfile   = null;
let currentChatId    = null;
let chatSubscription = null;
let chats            = [];
let pendingDeleteId  = null;
let typingChannel    = null;
let typingTimeout    = null;
let reportTargetId   = null;
let reportTargetName = null;

/* ══════════════════════════════════════════════════════
   SERVICE WORKER + NOTIFICATIONS
══════════════════════════════════════════════════════ */
let swRegistration = null;

async function registerServiceWorker() {
  if (!('serviceWorker' in navigator)) return;
  try {
    swRegistration = await navigator.serviceWorker.register('./sw.js', { scope: './' });
  } catch(e) {
    console.warn('SW registration failed:', e);
  }
}

// Send user ID + auth token to SW so it can call Supabase
async function sendUserToSW() {
  if (!currentUser) return;
  const { data: { session } } = await sb.auth.getSession();
  if (!session?.access_token) return;

  // Wait until SW is controlling the page
  await navigator.serviceWorker.ready;
  const ctrl = navigator.serviceWorker.controller;
  if (!ctrl) return;

  ctrl.postMessage({
    type: 'SET_USER',
    userId: currentUser.id,
    token: session.access_token
  });
}

function signOutSW() {
  navigator.serviceWorker?.controller?.postMessage({ type: 'SIGN_OUT' });
}

function updateNotifBtn() {
  const btn = document.getElementById('notif-toggle-btn');
  if (!btn) return;
  if (!('Notification' in window) || !('serviceWorker' in navigator)) {
    btn.style.display = 'none'; return;
  }
  const stored = localStorage.getItem('notif-enabled');
  const on = Notification.permission === 'granted' && stored !== 'false';
  btn.innerHTML = on
    ? '<i class="fa-solid fa-bell" style="width:12px;margin-right:6px"></i>Notifications On'
    : '<i class="fa-regular fa-bell" style="width:12px;margin-right:6px"></i>Enable Notifications';
  btn.style.color = on ? 'var(--accent)' : '';
}

async function toggleNotifications() {
  if (!('Notification' in window)) {
    showToast('Notifications not supported in this browser.', 'error'); return;
  }

  const stored = localStorage.getItem('notif-enabled');
  const currentlyOn = Notification.permission === 'granted' && stored !== 'false';

  if (currentlyOn) {
    // DISABLE
    localStorage.setItem('notif-enabled', 'false');
    navigator.serviceWorker?.controller?.postMessage({ type: 'DISABLE' });
    showToast('Notifications disabled.', '');
    updateNotifBtn();
    return;
  }

  // ENABLE — request permission if needed
  let permission = Notification.permission;
  if (permission === 'default') {
    permission = await Notification.requestPermission();
  }
  if (permission === 'denied') {
    showToast('Notifications blocked — please enable in your browser settings.', 'error'); return;
  }
  if (permission === 'granted') {
    localStorage.setItem('notif-enabled', 'true');
    await sendUserToSW();
    showToast('Notifications enabled!', 'success');
    updateNotifBtn();
  }
}

// Register SW immediately on page load
registerServiceWorker();

/* Soft two-tone chime using Web Audio */
function playChime() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    [[880, 0, 0.12], [659, 0.13, 0.22]].forEach(([freq, start, end]) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value = freq; osc.type = 'sine';
      gain.gain.setValueAtTime(0, ctx.currentTime + start);
      gain.gain.linearRampToValueAtTime(0.18, ctx.currentTime + start + 0.02);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + end);
      osc.start(ctx.currentTime + start);
      osc.stop(ctx.currentTime + end + 0.05);
    });
  } catch(_) {}
}


/* ══════════════════════════════════════════════════════
   MOBILE SIDEBAR
══════════════════════════════════════════════════════ */
function openSidebar() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebar-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

/* ══════════════════════════════════════════════════════
   IP DETECTION
══════════════════════════════════════════════════════ */
async function detectAndStoreIP() {
  if (!currentUser) return;
  try {
    const res = await fetch('https://api.ipify.org?format=json');
    const { ip } = await res.json();
    if (ip) {
      await sb.from('profiles')
        .update({ last_ip: ip, last_seen: new Date().toISOString() })
        .eq('id', currentUser.id);
    }
  } catch (_) {}
}

/* ══════════════════════════════════════════════════════
   INIT
══════════════════════════════════════════════════════ */
async function init() {
  let initialSessionHandled = false;
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    initialSessionHandled = true;
    currentUser = session.user;
    await handleSessionUser();
  }

  sb.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session) {
      if (initialSessionHandled && session.user.id === currentUser?.id) {
        initialSessionHandled = false; return;
      }
      initialSessionHandled = false;
      currentUser = session.user;
      await handleSessionUser();
    } else if (event === 'SIGNED_OUT') {
      currentUser = null; currentProfile = null;
      resetAppState(); showAuthPage();
    }
  });
}

async function handleSessionUser() {
  const { data: profile } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
  if (!profile) { showUsernameSetup(); return; }

  if (profile.last_login) {
    const age = Date.now() - new Date(profile.last_login).getTime();
    if (age > 50 * 24 * 60 * 60 * 1000) {
      await sb.auth.signOut();
      showToast('Session expired after 50 days. Please sign in again.', 'error');
      return;
    }
  }

  const newCode = genChatCode();
  await sb.from('profiles').update({ chat_code: newCode, last_login: new Date().toISOString() }).eq('id', currentUser.id);
  currentProfile = { ...profile, chat_code: newCode };

  document.getElementById('dd-username').textContent = currentProfile.username;
  document.getElementById('dd-username-mobile').textContent = currentProfile.username;
  document.getElementById('my-chat-code').textContent = newCode;

  // Update notification button state
  updateNotifBtn();

  detectAndStoreIP();

  // Re-connect SW if notifications were already enabled
  if (Notification.permission === 'granted' && localStorage.getItem('notif-enabled') !== 'false') {
    sendUserToSW();
  }
  showApp();
}

function resetAppState() {
  currentChatId = null; chats = [];
  if (chatSubscription) { chatSubscription.unsubscribe(); chatSubscription = null; }
  if (typingChannel) { typingChannel.unsubscribe(); typingChannel = null; }
  document.getElementById('chat-header').classList.remove('visible');
  document.getElementById('messages-wrap').classList.remove('visible');
  document.getElementById('chat-input-bar').classList.remove('visible');
  document.getElementById('chat-welcome').style.display = 'flex';
  document.getElementById('mobile-topbar').style.display = '';
}

/* ══════════════════════════════════════════════════════
   AUTH
══════════════════════════════════════════════════════ */
function showLogin() {
  document.getElementById('login-form').style.display = 'block';
  document.getElementById('signup-form').style.display = 'none';
  document.getElementById('username-setup').style.display = 'none';
  clearAuthError();
}
function showSignup() {
  document.getElementById('login-form').style.display = 'none';
  document.getElementById('signup-form').style.display = 'block';
  document.getElementById('username-setup').style.display = 'none';
  clearAuthError();
}
function showUsernameSetup() {
  document.getElementById('login-form').style.display = 'none';
  document.getElementById('signup-form').style.display = 'none';
  document.getElementById('username-setup').style.display = 'block';
  document.getElementById('auth-page').classList.add('active');
  document.getElementById('app-page').classList.remove('active');
  clearAuthError();
  setTimeout(() => document.getElementById('setup-username').focus(), 100);
}
function clearAuthError() {
  const el = document.getElementById('auth-global-error');
  el.classList.remove('visible'); el.textContent = '';
}
function showAuthError(msg) {
  const el = document.getElementById('auth-global-error');
  el.textContent = msg; el.classList.add('visible');
}
function checkPasswordRules(val) {
  document.getElementById('rule-upper').classList.toggle('met', /[A-Z]/.test(val));
  document.getElementById('rule-lower').classList.toggle('met', /[a-z]/.test(val));
  document.getElementById('rule-num').classList.toggle('met', /[0-9]/.test(val));
  document.getElementById('rule-special').classList.toggle('met', /[^A-Za-z0-9]/.test(val));
}
function validatePassword(pw) {
  return /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw);
}
function genChatCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({ length: 6 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
}

async function doGithubAuth() {
  document.querySelectorAll('.github-auth-btn').forEach(b => { b.disabled = true; b.textContent = 'Redirecting…'; });
  clearAuthError();
  const { error } = await sb.auth.signInWithOAuth({
    provider: 'github',
    options: { redirectTo: 'https://partials-gh.github.io/chatbubble/' }
  });
  if (error) {
    showAuthError(error.message);
    document.querySelectorAll('.github-auth-btn').forEach(b => { b.disabled = false; });
  }
}
async function doLogin() {
  clearAuthError();
  const email = document.getElementById('login-email').value.trim();
  const pw = document.getElementById('login-password').value;
  const btn = document.getElementById('login-btn');
  if (!email || !pw) { showAuthError('Please fill in all fields.'); return; }
  btn.disabled = true; btn.textContent = 'Signing in…';
  const { error } = await sb.auth.signInWithPassword({ email, password: pw });
  if (error) { showAuthError(error.message); btn.disabled = false; btn.textContent = 'Sign In'; }
}
async function doSignup() {
  clearAuthError();
  const email = document.getElementById('signup-email').value.trim();
  const pw = document.getElementById('signup-password').value;
  const btn = document.getElementById('signup-btn');
  if (!email || !pw) { showAuthError('Please fill in all fields.'); return; }
  if (!validatePassword(pw)) { showAuthError('Password must have 1 uppercase, 1 lowercase, 1 number, and 1 special character.'); return; }
  btn.disabled = true; btn.textContent = 'Creating account…';
  const { error } = await sb.auth.signUp({ email, password: pw });
  if (error) { showAuthError(error.message); btn.disabled = false; btn.textContent = 'Create Account'; return; }
}
async function doUsernameSetup() {
  const username = document.getElementById('setup-username').value.trim();
  const tos = document.getElementById('tos-checkbox').checked;
  const btn = document.getElementById('setup-btn');
  const errEl = document.getElementById('onboarding-error');
  errEl.style.display = 'none'; errEl.textContent = '';
  if (!username || username.length < 2) { showOnboardingError('Username must be at least 2 characters.'); return; }
  if (!/^[a-zA-Z0-9_]+$/.test(username)) { showOnboardingError('Username can only contain letters, numbers, and underscores.'); return; }
  if (!tos) { showOnboardingError('You must agree to the TOS to continue.'); return; }
  btn.disabled = true; btn.textContent = 'Checking…';
  const { data: existing } = await sb.from('profiles').select('id').eq('username', username).maybeSingle();
  if (existing) { showOnboardingError('That username is taken. Try another.'); btn.disabled = false; btn.textContent = 'Enter Chat Bubble'; return; }
  btn.textContent = 'Setting up…';
  const { error } = await sb.from('profiles').insert({ id: currentUser.id, username, chat_code: genChatCode() });
  if (error) { showOnboardingError(error.message); btn.disabled = false; btn.textContent = 'Enter Chat Bubble'; return; }
  await handleSessionUser();
}
function showOnboardingError(msg) {
  const el = document.getElementById('onboarding-error');
  el.textContent = msg; el.style.display = 'block';
}
function clearOnboardingError() {
  const el = document.getElementById('onboarding-error');
  if (el) { el.style.display = 'none'; el.textContent = ''; }
}
async function doLogout() {
  closeUserDropdown();
  signOutSW();
  await sb.auth.signOut();
}

/* ══════════════════════════════════════════════════════
   PAGE SWITCHING
══════════════════════════════════════════════════════ */
function showApp() {
  document.getElementById('auth-page').classList.remove('active');
  document.getElementById('app-page').classList.add('active');
  loadChats();
}
function showAuthPage() {
  document.getElementById('app-page').classList.remove('active');
  document.getElementById('auth-page').classList.add('active');
  showLogin();
}

/* ══════════════════════════════════════════════════════
   USER DROPDOWN
══════════════════════════════════════════════════════ */
function toggleUserDropdown() { document.getElementById('user-dropdown').classList.toggle('open'); }
function closeUserDropdown()  { document.getElementById('user-dropdown').classList.remove('open'); }
function toggleUserDropdownMobile() { document.getElementById('user-dropdown-mobile').classList.toggle('open'); }

document.addEventListener('click', e => {
  if (!e.target.closest('#user-btn') && !e.target.closest('#user-dropdown')) closeUserDropdown();
  if (!e.target.closest('#user-dropdown-mobile') && !e.target.closest('.mobile-topbar .sidebar-user-btn'))
    document.getElementById('user-dropdown-mobile').classList.remove('open');
});

/* ══════════════════════════════════════════════════════
   CHATS
══════════════════════════════════════════════════════ */
async function loadChats() {
  const { data } = await sb.from('chats')
    .select('*')
    .or(`owner_id.eq.${currentUser.id},partner_id.eq.${currentUser.id}`)
    .order('updated_at', { ascending: false });
  chats = data || [];
  renderChatList();
}

function renderChatList() {
  const list = document.getElementById('chat-list');
  if (!chats.length) {
    list.innerHTML = '<div class="chat-empty"><div class="chat-empty-icon"><i class="fa-regular fa-comments"></i></div>No chats yet.<br>Use someone\'s code below.</div>';
    return;
  }
  list.innerHTML = chats.map(chat => {
    const isOwner = chat.owner_id === currentUser.id;
    const otherName = isOwner ? (chat.partner_username || '…waiting') : (chat.owner_username || '?');
    const initial = otherName[0]?.toUpperCase() || '?';
    const active = chat.id === currentChatId ? 'active' : '';
    const preview = chat.last_message || 'No messages yet';
    return `<div class="chat-item ${active}" onclick="openChat('${chat.id}')">
      <div class="chat-avatar">${initial}<div class="unread-badge" id="badge-${chat.id}"></div></div>
      <div class="chat-item-info">
        <div class="chat-item-name">${escHtml(otherName)}</div>
        <div class="chat-item-preview">${escHtml(preview)}</div>
      </div>
      <button class="chat-item-del" onclick="openDeleteChat(event,'${chat.id}')" title="Delete">
        <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>
      </button>
    </div>`;
  }).join('');
}

async function openChat(chatId) {
  // Clear unread badge
  const badge = document.getElementById(`badge-${chatId}`);
  if (badge) badge.classList.remove('visible');

  currentChatId = chatId;
  clearTypingIndicator();
  renderChatList();
  closeSidebar();

  const chat = chats.find(c => c.id === chatId);
  if (!chat) return;
  const isOwner = chat.owner_id === currentUser.id;
  const otherName = isOwner ? (chat.partner_username || '…waiting') : (chat.owner_username || '?');

  document.getElementById('chat-header-avatar').textContent = otherName[0]?.toUpperCase() || '?';
  document.getElementById('chat-header-name').textContent = otherName;
  document.getElementById('chat-header').classList.add('visible');
  document.getElementById('messages-wrap').classList.add('visible');
  document.getElementById('chat-input-bar').classList.add('visible');
  document.getElementById('chat-welcome').style.display = 'none';
  document.getElementById('mobile-topbar').style.display = 'none';

  await loadMessages(chatId);
  subscribeToChat(chatId);
  setTimeout(() => document.getElementById('chat-input').focus(), 150);
}

async function loadMessages(chatId) {
  const wrap = document.getElementById('messages-wrap');
  wrap.innerHTML = '';
  const { data: messages } = await sb.from('messages')
    .select('*, profiles(username)')
    .eq('chat_id', chatId)
    .order('created_at', { ascending: true });

  if (!messages?.length) {
    wrap.innerHTML = '<div class="msg-placeholder" style="text-align:center;color:var(--text-dim);font-size:12px;padding:40px 0">No messages yet. Say hello.</div>';
    return;
  }

  let lastDate = null;
  messages.forEach(msg => {
    const dateStr = new Date(msg.created_at).toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' });
    if (dateStr !== lastDate) {
      lastDate = dateStr;
      const divider = document.createElement('div');
      divider.className = 'msg-date-divider';
      divider.textContent = dateStr;
      wrap.appendChild(divider);
    }
    const tmp = document.createElement('div');
    tmp.innerHTML = renderMessage(msg);
    wrap.appendChild(tmp.firstElementChild);
  });
  wrap.scrollTop = wrap.scrollHeight;
}

function renderMessage(msg) {
  const mine = msg.user_id === currentUser.id;
  const time = new Date(msg.created_at).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
  const initial = escHtml((msg.profiles?.username?.[0] || '?').toUpperCase());
  return `<div class="msg-row ${mine ? 'mine' : ''}">
    <div class="msg-avatar ${mine ? 'hidden' : ''}">${initial}</div>
    <div class="msg-bubble">${escHtml(msg.content)}</div>
    <div class="msg-time">${time}</div>
  </div>`;
}

/* ══════════════════════════════════════════════════════
   REALTIME SUBSCRIPTION
   Broadcast only — no Postgres fallback for messages
   (that was causing the duplicate bug)
══════════════════════════════════════════════════════ */
function subscribeToChat(chatId) {
  if (chatSubscription) chatSubscription.unsubscribe();
  typingChannel = null;

  const chat = chats.find(c => c.id === chatId);
  const isOwner = chat?.owner_id === currentUser.id;
  const otherName = isOwner ? (chat?.partner_username || '?') : (chat?.owner_username || '?');

  chatSubscription = sb.channel(`room-${chatId}`, {
    config: {
      broadcast: { self: false },
      presence:  { key: currentUser.id }
    }
  })

  // ── Broadcast: new message from partner ──
  .on('broadcast', { event: 'new_message' }, ({ payload }) => {
    if (currentChatId !== chatId) return;
    if (payload.user_id === currentUser.id) return; // already rendered optimistically

    const wrap = document.getElementById('messages-wrap');
    const placeholder = wrap.querySelector('.msg-placeholder');
    if (placeholder) placeholder.remove();

    const tmp = document.createElement('div');
    tmp.innerHTML = renderMessage(payload);
    wrap.appendChild(tmp.firstElementChild);
    wrap.scrollTop = wrap.scrollHeight;

    // Update sidebar preview
    const chat = chats.find(c => c.id === chatId);
    if (chat) {
      chat.last_message = payload.content;
      const previewEl = document.querySelector(`.chat-item[onclick="openChat('${chatId}')"] .chat-item-preview`);
      if (previewEl) previewEl.textContent = payload.content;
    }

    // Chime for incoming message
    playChime();
  })

  // ── Presence: typing state ──
  .on('presence', { event: 'sync' }, () => {
    const state = chatSubscription.presenceState();
    const others = Object.entries(state)
      .filter(([key]) => key !== currentUser.id)
      .map(([, val]) => val[0]);
    const isTyping = others.some(u => u?.typing === true);
    const indicator = document.getElementById('typing-indicator');
    if (isTyping && currentChatId === chatId) {
      indicator.innerHTML = `<span>${escHtml(otherName)} is typing</span><div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
      indicator.classList.add('visible');
    } else {
      clearTypingIndicator();
    }
  })

  .subscribe();

  typingChannel = chatSubscription;
}

// Also subscribe globally to new chats being created for this user
// so they get notified even when no chat is open
function subscribeToNewChats() {
  sb.channel('new-chats')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'chats',
      filter: `owner_id=eq.${currentUser.id}`
    }, async () => {
      await loadChats();
      playChime();
    })
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'chats',
      filter: `partner_id=eq.${currentUser.id}`
    }, async () => {
      await loadChats();
      playChime();
    })
    .subscribe();
}

function clearTypingIndicator() {
  const indicator = document.getElementById('typing-indicator');
  indicator.innerHTML = '';
  indicator.classList.remove('visible');
}

function handleTyping() {
  if (!chatSubscription || !currentChatId) return;
  chatSubscription.track({ typing: true });
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    if (chatSubscription) chatSubscription.track({ typing: false });
  }, 2000);
}

/* ══════════════════════════════════════════════════════
   SEND MESSAGE  (optimistic + broadcast only)
══════════════════════════════════════════════════════ */
async function sendMessage() {
  const input = document.getElementById('chat-input');
  const content = input.value.trim();
  if (!content || !currentChatId) return;
  input.value = '';
  autoResize(input);

  if (chatSubscription) { clearTimeout(typingTimeout); chatSubscription.track({ typing: false }); }

  // 1. Optimistic render
  const optimisticMsg = {
    id: `opt-${Date.now()}`,
    user_id: currentUser.id,
    chat_id: currentChatId,
    content,
    created_at: new Date().toISOString(),
    profiles: { username: currentProfile?.username || '?' }
  };
  const wrap = document.getElementById('messages-wrap');
  const placeholder = wrap.querySelector('.msg-placeholder');
  if (placeholder) placeholder.remove();
  const tmp = document.createElement('div');
  tmp.innerHTML = renderMessage(optimisticMsg);
  wrap.appendChild(tmp.firstElementChild);
  wrap.scrollTop = wrap.scrollHeight;

  // 2. Broadcast to partner
  chatSubscription?.send({
    type: 'broadcast',
    event: 'new_message',
    payload: optimisticMsg
  });

  // 3. Persist to DB
  const { error: msgErr } = await sb.from('messages').insert({
    chat_id: currentChatId,
    user_id: currentUser.id,
    content
  });
  if (msgErr) {
    showToast('Failed to send message.', 'error');
    input.value = content;
    autoResize(input);
    return;
  }

  // 4. Update chat metadata
  await sb.from('chats').update({
    updated_at: new Date().toISOString(),
    last_message: content
  }).eq('id', currentChatId);

  const chat = chats.find(c => c.id === currentChatId);
  if (chat) {
    chat.last_message = content;
    const previewEl = document.querySelector(`.chat-item[onclick="openChat('${currentChatId}')"] .chat-item-preview`);
    if (previewEl) previewEl.textContent = content;
  }
}

function handleInputKey(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 120) + 'px'; }

/* ══════════════════════════════════════════════════════
   JOIN CHAT
══════════════════════════════════════════════════════ */
function openJoinChat() {
  document.getElementById('join-modal').classList.add('visible');
  document.getElementById('join-input').value = '';
  document.getElementById('join-error').textContent = '';
  document.getElementById('join-input').classList.remove('error');
  document.getElementById('join-submit-btn').disabled = false;
  document.getElementById('join-submit-btn').textContent = 'Join';
  setTimeout(() => document.getElementById('join-input').focus(), 100);
}
function closeJoinModal() { document.getElementById('join-modal').classList.remove('visible'); }

async function doJoinChat() {
  const code = document.getElementById('join-input').value.trim().toUpperCase();
  const errEl = document.getElementById('join-error');
  const btn = document.getElementById('join-submit-btn');
  const input = document.getElementById('join-input');
  errEl.textContent = ''; input.classList.remove('error');

  if (code.length !== 6) { input.classList.add('error'); errEl.textContent = 'Code must be exactly 6 characters.'; return; }
  btn.disabled = true; btn.textContent = 'Looking up…';

  const { data: ownerProfile, error: profileErr } = await sb.from('profiles').select('*').eq('chat_code', code).maybeSingle();
  if (profileErr || !ownerProfile) {
    input.classList.add('error'); errEl.textContent = 'No user found with that code.';
    btn.disabled = false; btn.textContent = 'Join'; return;
  }
  if (ownerProfile.id === currentUser.id) {
    input.classList.add('error'); errEl.textContent = "That's your own code!";
    btn.disabled = false; btn.textContent = 'Join'; return;
  }

  btn.textContent = 'Checking…';
  const { data: existing } = await sb.from('chats').select('id')
    .or(`and(owner_id.eq.${currentUser.id},partner_id.eq.${ownerProfile.id}),and(owner_id.eq.${ownerProfile.id},partner_id.eq.${currentUser.id})`)
    .maybeSingle();

  if (existing) {
    closeJoinModal(); btn.disabled = false; btn.textContent = 'Join';
    await loadChats(); openChat(existing.id); return;
  }

  btn.textContent = 'Creating chat…';
  const { data: newChat, error: chatErr } = await sb.from('chats').insert({
    owner_id: ownerProfile.id,
    partner_id: currentUser.id,
    owner_username: ownerProfile.username,
    partner_username: currentProfile.username,
    last_message: '',
    updated_at: new Date().toISOString()
  }).select().single();

  btn.disabled = false; btn.textContent = 'Join';
  if (chatErr) { errEl.textContent = `Error: ${chatErr.message}`; return; }
  closeJoinModal();
  await loadChats();
  openChat(newChat.id);
}

/* ══════════════════════════════════════════════════════
   DELETE CHAT
══════════════════════════════════════════════════════ */
function openDeleteChat(e, chatId) {
  e.stopPropagation();
  pendingDeleteId = chatId;
  document.getElementById('delete-modal').classList.add('visible');
}
function closeDeleteModal() { document.getElementById('delete-modal').classList.remove('visible'); pendingDeleteId = null; }

async function confirmDeleteChat() {
  if (!pendingDeleteId) return;
  const btn = document.getElementById('confirm-delete-btn');
  btn.disabled = true; btn.textContent = 'Deleting…';
  await sb.from('messages').delete().eq('chat_id', pendingDeleteId);
  await sb.from('chats').delete().eq('id', pendingDeleteId);
  if (currentChatId === pendingDeleteId) {
    currentChatId = null;
    if (chatSubscription) { chatSubscription.unsubscribe(); chatSubscription = null; typingChannel = null; }
    clearTypingIndicator();
    document.getElementById('chat-header').classList.remove('visible');
    document.getElementById('messages-wrap').classList.remove('visible');
    document.getElementById('chat-input-bar').classList.remove('visible');
    document.getElementById('chat-welcome').style.display = 'flex';
    document.getElementById('mobile-topbar').style.display = '';
  }
  btn.disabled = false; btn.textContent = 'Delete Chat';
  closeDeleteModal();
  await loadChats();
  showToast('Chat deleted.', 'success');
}

/* ══════════════════════════════════════════════════════
   CONTEXT MENU
══════════════════════════════════════════════════════ */
const ctxMenu = document.getElementById('ctx-menu');

document.addEventListener('contextmenu', e => {
  e.preventDefault();
  const x = Math.min(e.clientX, window.innerWidth - 190);
  const y = Math.min(e.clientY, window.innerHeight - 130);
  ctxMenu.style.left = x + 'px'; ctxMenu.style.top = y + 'px';
  const loggedIn = !!currentUser;
  document.getElementById('ctx-report-btn').style.display = loggedIn ? 'flex' : 'none';
  document.getElementById('ctx-logout-btn').style.display = loggedIn ? 'flex' : 'none';
  document.getElementById('ctx-sep').style.display = loggedIn ? 'block' : 'none';
  ctxMenu.classList.add('visible');
});
document.addEventListener('mousedown', e => {
  if (!ctxMenu.contains(e.target)) ctxMenu.classList.remove('visible');
});
function ctxRefresh() { ctxMenu.classList.remove('visible'); location.reload(); }
function ctxLogout()  { ctxMenu.classList.remove('visible'); doLogout(); }

/* ══════════════════════════════════════════════════════
   REPORT
══════════════════════════════════════════════════════ */
function ctxReport() {
  ctxMenu.classList.remove('visible');
  if (!currentChatId) { showToast('Open a chat first to report someone.', 'error'); return; }
  const chat = chats.find(c => c.id === currentChatId);
  if (!chat) { showToast('Could not identify a user to report.', 'error'); return; }
  const isOwner = chat.owner_id === currentUser.id;
  reportTargetId = isOwner ? chat.partner_id : chat.owner_id;
  reportTargetName = isOwner ? chat.partner_username : chat.owner_username;
  document.getElementById('report-target-name').textContent = reportTargetName || 'Unknown';
  document.getElementById('report-reason').value = '';
  document.getElementById('report-error').textContent = '';
  document.getElementById('report-submit-btn').disabled = false;
  document.getElementById('report-submit-btn').textContent = 'Submit Report';
  document.getElementById('report-modal').classList.add('visible');
  setTimeout(() => document.getElementById('report-reason').focus(), 100);
}
function closeReportModal() {
  document.getElementById('report-modal').classList.remove('visible');
  reportTargetId = null; reportTargetName = null;
}
async function submitReport() {
  const reason = document.getElementById('report-reason').value.trim();
  const errEl = document.getElementById('report-error');
  const btn = document.getElementById('report-submit-btn');
  if (!reason) { errEl.textContent = 'Please describe the reason for reporting.'; return; }
  if (!reportTargetId) { errEl.textContent = 'Could not identify the reported user.'; return; }
  btn.disabled = true; btn.textContent = 'Submitting…';
  const { error } = await sb.from('reports').insert({
    reporter_id: currentUser.id,
    reporter_name: currentProfile?.username || '?',
    reported_id: reportTargetId,
    reported_name: reportTargetName || '?',
    reason,
    chat_id: currentChatId
  });
  if (error) { errEl.textContent = `Failed: ${error.message}`; btn.disabled = false; btn.textContent = 'Submit Report'; return; }
  closeReportModal();
  showToast('Report submitted. Thank you.', 'success');
}

/* ══════════════════════════════════════════════════════
   UTILS
══════════════════════════════════════════════════════ */
function copyMyChatCode() {
  const code = document.getElementById('my-chat-code').textContent;
  if (!code || code === '——————') return;
  navigator.clipboard.writeText(code)
    .then(() => showToast('Chat code copied!', 'success'))
    .catch(() => showToast('Could not copy — try manually.', 'error'));
}
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 2800);
}
function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

document.querySelectorAll('.modal-backdrop').forEach(el => {
  el.addEventListener('mousedown', function(e) {
    if (e.target === this) {
      this.classList.remove('visible');
      if (this.id === 'delete-modal') pendingDeleteId = null;
      if (this.id === 'report-modal') { reportTargetId = null; reportTargetName = null; }
    }
  });
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-backdrop').forEach(el => el.classList.remove('visible'));
    ctxMenu.classList.remove('visible');
    pendingDeleteId = null; reportTargetId = null; reportTargetName = null;
  }
});

init().then(() => {
  if (currentUser) subscribeToNewChats();
});
</script>
</body>
</html>
